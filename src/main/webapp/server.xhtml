<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	template="layout/core.xhtml">

	<ui:param name="formencoding" value="multipart/form-data" />

	<ui:define name="title">
		<h:outputText value="#{messages.server}" />
	</ui:define>

	<ui:define name="head">
		<style type="text/css">
.history_entry {
	position: absolute;
	height: 20px;
	top: 0;
	text-shadow: 0 0 4px #ffffff;
}
</style>
	</ui:define>

	<rich:panel header="#{messages.server}">
		<h:panelGrid columns="3" columnClasses="caption,value,help">
			<h:outputText value="#{messages.server_name}" />
			<h:inputText value="#{serverDetail.instance.name}" id="server_name" />
			<h:outputText value="#{messages.server_name_help}" />

			<h:outputText value="#{messages.server_description}" />
			<h:inputTextarea value="#{serverDetail.instance.description}"
				id="server_description" rows="2" cols="40" />
			<h:outputText value="#{messages.server_description_help}" />

			<h:outputText value="#{messages.server_targetdir}" />
			<h:inputText value="#{serverDetail.instance.targetdir}"
				id="server_targetdir" />
			<h:outputText value="#{messages.server_targetdir_help}" />

			<h:outputText value="#{messages.server_icon}" />
			<h:panelGroup>
				<h:graphicImage
					value="/service/resources/server/#{serverDetail.instance.iconId}"
					height="16" rendered="#{not empty serverDetail.instance.iconId}" />
				<h:inputFile value="#{serverDetail.icon}" />
			</h:panelGroup>
			<h:outputText value="#{messages.server_icon_help}" />

			<h:outputText value="#{messages.server_configuredProjects}" />
			<rich:pickList value="#{serverDetail.instance.configuredProjects}"
				converter="projectConverter" addAllText="⇒" removeAllText="⇐"
				addText="→" removeText="←" minListHeight="100">
				<f:selectItems value="#{selectItemBean.allProjectSelectItems}" />
			</rich:pickList>
			<h:outputText value="#{messages.server_configuredProjects_help}" />
		</h:panelGrid>
	</rich:panel>

	<rich:panel header="#{messages.server_vcsconfiguration}">
		<h:panelGrid columns="3" columnClasses="caption,value,help">

			<h:outputText value="#{messages.server_vcsHost}" />
			<h:selectOneMenu value="#{serverDetail.instance.vcsHost}"
				id="server_vcsHost" converter="vcshostConverter">
				<f:selectItem itemValue="#{null}"
					itemLabel="#{messages.vcshost_none}" />
				<f:selectItems value="#{selectItemBean.allVcshostSelectItems}" />
				<f:ajax event="change"
					render="server_uri server_vcsPath server_targetPath" />
			</h:selectOneMenu>
			<h:outputText value="#{messages.server_vcsHost_help}" />
			<h:outputText value="" />
			<h:outputText id="server_uri"
				value="#{serverDetail.instance.vcsHost.uri}" />
			<h:outputText value="" />

			<h:outputText value="#{messages.server_vcsPath}" />
			<h:inputText value="#{serverDetail.instance.vcsPath}"
				id="server_vcsPath"
				disabled="#{empty serverDetail.instance.vcsHost}" />
			<h:outputText value="#{messages.server_vcsPath_help}" />

			<h:outputText value="#{messages.server_targetPath}" />
			<h:inputText value="#{serverDetail.instance.targetPath}"
				id="server_targetPath"
				disabled="#{empty serverDetail.instance.vcsHost}" />
			<h:outputText value="#{messages.server_targetPath_help}" />
		</h:panelGrid>
	</rich:panel>

	<rich:tabPanel switchType="client">
		<rich:tab
			header="#{messages.variables} (#{serverDetail.instance.variables.size()})">

			<h:outputFormat value="#{messages.server_variables_for}"
				escape="false">
				<f:param value="#{messages.actionCopy}" />
				<f:param value="#{messages.actionCopy_targetPath}" />
				<f:param value="#{messages.actionExtraction}" />
				<f:param value="#{messages.actionExtraction_source}" />
				<f:param value="#{messages.actionExtraction_destination}" />
			</h:outputFormat>

			<ui:repeat var="variable" value="#{serverDetail.instance.variables}"
				varStatus="status">
				<h:commandLink action="#{serverDetail.deleteVariable(variable)}"
					class="deletionlink" title="#{messages.variable_delete}">
					<h:graphicImage value="/images/elementary/edit-delete.png" />
				</h:commandLink>
				<h:panelGrid columns="3" columnClasses="caption,value,help">
					<h:outputText value="#{messages.variable_name}" />
					<h:inputText value="#{variable.name}" />
					<h:outputText
						value="#{status.first ? messages.variable_name_help : ''}" />
					<h:outputText value="#{messages.variable_value}" />
					<h:inputText value="#{variable.value}" />
					<h:outputText
						value="#{status.first ? messages.variable_value_help : ''}" />
				</h:panelGrid>
			</ui:repeat>

			<h:panelGrid columns="3" columnClasses="caption,value,help">
				<h:outputText value="" />
				<h:commandLink action="#{serverDetail.addVariable}">
					<h:graphicImage value="/images/elementary/add.png"
						styleClass="linkimage" />
					<h:outputText value="#{messages.variable_add}"
						styleClass="linktext" />
				</h:commandLink>
				<h:outputText value="" />
			</h:panelGrid>
		</rich:tab>
		<rich:tab
			header="#{messages.actionReplacements} (#{serverDetail.instance.actionReplacements.size()})">
			<ui:include src="/layout/actionReplacement.xhtml">
				<ui:param name="entityDetail" value="#{serverDetail}" />
			</ui:include>
		</rich:tab>
	</rich:tabPanel>

	<h:commandButton value="#{messages.save}" id="save"
		action="#{serverDetail.save}" />

	<rich:collapsiblePanel header="#{messages.deployments}"
		rendered="#{serverDetail.managed}" switchType="client">
		<table>
			<tr>
				<td>
					<h3>
						<h:outputText value="#{messages.server_currently_deployed}" />
					</h3>
				</td>
				<td>
					<h3>
						<h:outputText value="#{messages.server_deployable}" />
					</h3>
				</td>
			</tr>
			<tr>
				<td style="vertical-align: top"><rich:dataTable
						value="#{serverDetail.deployedVersions}" var="version">
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages.project}" />
							</f:facet>
							<h:outputText value="#{version.project.name}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages.version}" />
							</f:facet>
							<h:outputText value="#{version.transformedVcsTag}" />
						</rich:column>
					</rich:dataTable></td>
				<td style="vertical-align: top"><rich:dataTable
						value="#{serverDetail.deployableVersions}" var="version">
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages.project}" />
							</f:facet>
							<h:outputText value="#{version.project.name}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages.version}" />
							</f:facet>
							<h:outputText value="#{version.transformedVcsTag}" />
						</rich:column>
					</rich:dataTable></td>
			</tr>
		</table>
	</rich:collapsiblePanel>

	<rich:collapsiblePanel header="#{messages.server_deployment_history}"
		rendered="#{serverDetail.managed}" switchType="client">
		<h3>
			<h:outputText
				value="#{messages.server_deployment_history_detail} (#{deploymentHistoryBean.readableDate(deploymentHistoryBean.getDeploymentHistory(serverDetail.instance).minDate)} - #{deploymentHistoryBean.readableDate(deploymentHistoryBean.getDeploymentHistory(serverDetail.instance).maxDate)})" />
		</h3>
		<table>
			<a4j:repeat
				value="#{deploymentHistoryBean.getDeploymentHistory(serverDetail.instance).entries}"
				var="entry">
				<tr>
					<th style="text-align: left; height: 18px;">#{entry.project.name}</th>
					<th style="position: relative;"><a4j:repeat
							value="#{entry.deploymentDurations}" var="deploymentDuration">
							<div class="history_entry"
								style="background-color: #{deploymentDuration.color"
								title="#{deploymentDuration.deployment.version.vcsTag}: #{deploymentHistoryBean.readableDate(deploymentDuration.deployment.deployment)} - #{deploymentHistoryBean.readableDate(deploymentDuration.deployment.undeployment)}">
								#{deploymentDuration.deployment.version.vcsTag}</div>
						</a4j:repeat></th>
				</tr>
			</a4j:repeat>
		</table>
	</rich:collapsiblePanel>

</ui:composition>